=<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PG County Animal Shelter Booking</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; margin:40px; }
    h2 { color:#333; }
    form { background:#fff; padding:20px; border-radius:8px; max-width:520px; box-shadow:0 0 8px rgba(0,0,0,0.1); }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select, textarea, button { width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #ccc; }
    button { background:#2a7be4; color:#fff; font-weight:bold; cursor:pointer; }
    button:hover { background:#1d5fb2; }
    .ok { background:#d6f5d6; border-left:4px solid #2e8b57; padding:10px; margin-top:15px; }
    .err { background:#f5d6d6; border-left:4px solid #b22222; padding:10px; margin-top:15px; }
    small { color:#666; }
  </style>
</head>

<body>

  <h2>Book an Interaction / Walkthrough</h2>

  <!-- FORM SECTION  -->
  <form id="form">

    <label for="first_name">First Name</label>
    <input name="first_name" id="first_name" required>

    <label for="last_name">Last Name</label>
    <input name="last_name" id="last_name" required>

    <label for="email">Email</label>
    <input name="email" id="email" type="email" required>

    <label for="phone">Phone</label>
    <input name="phone" id="phone" required>

    <label for="animalSelect">Choose Animal</label>
    <select id="animalSelect" name="animals_of_interest" required>
      <option value="Ben - A554331">Ben - A554331</option>
      <option value="Jesse - A563781">Jesse - A563781</option>
      <option value="Undecided">Undecided</option>
    </select>

    <label for="daySelect">Choose Day</label>
    <select id="daySelect" name="day" required></select>
    <small>We offer appointments Monday–Saturday (closed Sunday).</small>

    <label for="timeSelect">Choose Start Time</label>
    <select id="timeSelect" name="time" required></select>
    <small>Times shown match open hours for the selected day.</small>

    <label for="notes">Notes</label>
    <textarea name="notes" id="notes" placeholder="Any additional notes..."></textarea>

    <button type="submit">Book Appointment</button>
  </form>

  <div id="result"></div>

  <!-- SCRIPT SECTION (The Logic) -->
 <script>
// Step 1: Your n8n PRODUCTION webhook URL (not /webhook-test/)
const WEBHOOK = "https://lightnuwr.app.n8n.cloud/webhook/booking-demo";

document.addEventListener('DOMContentLoaded', function () {
  // Step 2: Hours config (0=Sun, 1=Mon, ... 6=Sat); null = closed
  const HOURS = {
    1: { open: "09:00", close: "17:30" }, // Monday
    2: { open: "10:30", close: "19:00" }, // Tuesday
    3: { open: "10:30", close: "19:00" }, // Wednesday
    4: { open: "10:30", close: "19:00" }, // Thursday
    5: { open: "10:30", close: "19:00" }, // Friday
    6: { open: "09:00", close: "17:30" }, // Saturday
    0: null                                // Sunday (closed)
  };

  // Step 3: Grab dropdowns
  const daySel  = document.getElementById('daySelect');
  const timeSel = document.getElementById('timeSelect');
  console.log('daySel:', daySel);
  console.log('timeSel:', timeSel);

  // Step 4: Helpers
  function addMinutes(hhmm, mins) {
    const [h, m] = hhmm.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m, 0, 0);
    d.setMinutes(d.getMinutes() + mins);
    return String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0");
  }
  function timeLT(a, b) {
    const [ah, am] = a.split(":").map(Number);
    const [bh, bm] = b.split(":").map(Number);
    return ah === bh ? am < bm : ah < bh;
  }
  function fmtDateISO(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,"0");
    const d = String(date.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  function fmtDateLabel(date) {
    return date.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
  }

  // Step 5: Build Day dropdown (next 10 days, skip Sundays)
  function populateDays() {
    daySel.innerHTML = "";
    const today = new Date();
    for (let i = 0; i < 10; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() + i);
      const dow = d.getDay(); // 0..6
      if (!HOURS[dow]) continue; // skip Sunday
      const opt = document.createElement('option');
      opt.value = fmtDateISO(d);          // "YYYY-MM-DD"
      opt.textContent = fmtDateLabel(d);  // "Tue, Oct 14"
      daySel.appendChild(opt);
    }
  }

  // Step 6: Build Time dropdown for selected day (every 30 mins in open hours)
  function populateTimesForDay(isoDate) {
    timeSel.innerHTML = "";
    const d = new Date(isoDate + "T00:00:00");
    const dow = d.getDay();
    const hours = HOURS[dow];
    if (!hours) return;

    let t = hours.open;
    const step = 30;        // minutes
    const last = hours.close;
    while (timeLT(t, last)) {
      const [h, m] = t.split(":").map(Number);
      const labelDate = new Date();
      labelDate.setHours(h, m, 0, 0);
      const label = labelDate.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' });

      const opt = document.createElement('option');
      opt.value = t;        // "HH:MM"
      opt.textContent = label;
      timeSel.appendChild(opt);

      t = addMinutes(t, step);
    }
  }

  // Step 7: Initialize + change handler
  populateDays();
  populateTimesForDay(daySel.value);
  daySel.addEventListener('change', function () {
    populateTimesForDay(daySel.value);
  });

  // Step 8: Submit handler (build payload, POST to n8n, render result)
  const formEl = document.getElementById('form');
  console.log('Form element:', formEl); // should NOT be null

  formEl.addEventListener('submit', function (e) {
    console.log('Submit handler fired'); // should print on click
    e.preventDefault();

    const resDiv = document.getElementById('result');
    resDiv.textContent = "Submitting…";

    const fd = new FormData(formEl);
    const day  = fd.get('day');  // "YYYY-MM-DD"
    const time = fd.get('time');  // "HH:MM"
    const local = new Date(day + "T" + time + ":00");

    function safeTrim(v){ return (v || '').toString().trim(); }

const payload = {
  appointment_type: "interaction",
  animals_of_interest: safeTrim(fd.get('animals_of_interest')) || 'Undecided',
  start: local.toISOString(),
  contact: {
    first_name: safeTrim(fd.get('first_name')),
    last_name:  safeTrim(fd.get('last_name')),
    email:      safeTrim(fd.get('email')),
    phone:      safeTrim(fd.get('phone'))
  },
  notes: safeTrim(fd.get('notes'))
};

    console.log('Payload to n8n:', payload);

    fetch(WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
      console.log('Response from n8n:', data);
      if (data.valid || data.ok) {
        resDiv.innerHTML = "<div class='ok'><b>Confirmed:</b><br>" +
                          (data.booking_note || data.message || "Your request was received!") +
                          "</div>";
      } else {
        const reasons = Array.isArray(data.reasons)
          ? data.reasons.join("<br>• ")
          : (data.reasons || "Please choose another time.");
        resDiv.innerHTML = "<div class='err'><b>Couldn’t book:</b><br>• " + reasons + "</div>";
      }
    })
    .catch(err => {
      console.error('Fetch error:', err);
      resDiv.innerHTML = "<div class='err'>Error contacting server.</div>";
    });
  });
});
</script>

</body>
</html>




